<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Guga-ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050509;
      --bg-elevated: #101018;
      --border: #262637;
      --accent: #5a7cff;
      --accent-soft: rgba(90, 124, 255, 0.12);
      --accent-strong: rgba(90, 124, 255, 0.35);
      --text: #f5f5f7;
      --text-muted: #9b9bb5;
      --danger: #ff5c5c;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-strong: 0 22px 50px rgba(0, 0, 0, 0.8);
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #1b233a 0, #050509 55%);
      color: var(--text);
      overflow: hidden;
    }

    .app {
      display: flex;
      height: 100vh;
    }

    /* SIDEBAR */

    .sidebar {
      width: 280px;
      border-right: 1px solid var(--border);
      background: rgba(5, 5, 12, 0.92);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      padding: 10px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .logo {
      font-weight: 800;
      letter-spacing: 0.12em;
      font-size: 14px;
      text-transform: uppercase;
      color: #ffffff;
    }

    .logo-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle, #6dffb5, #2cff87);
      margin-left: 6px;
      box-shadow: 0 0 12px rgba(109, 255, 181, 0.8);
    }

    .sidebar-footer {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    button,
    .button-like {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(140deg, #181827, #090910);
      color: var(--text);
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      transition:
        background 150ms ease,
        transform 120ms ease,
        box-shadow 150ms ease,
        border-color 150ms ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover,
    .button-like:hover {
      background: linear-gradient(140deg, #242645, #0e0e19);
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
      border-color: var(--accent-soft);
    }

    button:active,
    .button-like:active {
      transform: translateY(0);
      box-shadow: none;
    }

    #new-chat-btn {
      padding-inline: 10px;
      font-size: 12px;
    }

    #settings-btn {
      width: 100%;
      justify-content: center;
      font-size: 12px;
    }

    .chats-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 8px;
      padding-right: 4px;
    }

    .chat-item {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      transition: background 150ms ease, color 150ms ease, transform 120ms ease;
      position: relative;
    }

    .chat-item-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-item:hover {
      background: rgba(34, 36, 68, 0.8);
      color: var(--text);
      transform: translateY(-1px);
    }

    .chat-item.active {
      background: radial-gradient(circle at top left, rgba(90, 124, 255, 0.35), rgba(15, 15, 30, 0.96));
      color: #ffffff;
      box-shadow: var(--shadow-soft);
    }

    .chat-item-delete {
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 0;
      font-size: 16px;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .chat-item-delete:hover {
      background: rgba(255, 92, 92, 0.15);
      color: var(--danger);
    }

    /* CHAT AREA */

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .chat-header {
      padding: 10px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: linear-gradient(135deg, rgba(14, 16, 28, 0.98), rgba(6, 6, 12, 0.96));
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.6);
      z-index: 2;
    }

    .model-indicator {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .model-pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(116, 144, 255, 0.9);
      background: radial-gradient(circle at top left, rgba(116, 144, 255, 0.5), rgba(8, 8, 18, 0.96));
      color: #ffffff;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .model-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #7affc1;
      box-shadow: 0 0 10px rgba(122, 255, 193, 0.9);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
    }

    .toggle input {
      display: none;
    }

    .toggle-switch {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: #2b2b3a;
      position: relative;
      transition: background 150ms ease;
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #c0c0ff;
      transition: transform 150ms ease, background 150ms ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }

    .toggle input:checked + .toggle-switch {
      background: #4d6bff;
    }

    .toggle input:checked + .toggle-switch .toggle-thumb {
      transform: translateX(14px);
      background: #ffffff;
    }

    .temp-display {
      font-size: 11px;
      color: var(--text-muted);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 18px 14px;
      position: relative;
      scroll-behavior: smooth;
    }

    .messages-inner {
      max-width: 780px;
      margin: 0 auto;
      padding-bottom: 10px;
    }

    .starter-hint {
      text-align: center;
      margin-top: 24px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .starter-hint-title {
      font-size: 15px;
      margin-bottom: 4px;
      color: var(--text);
    }

    .starter-tags {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }

    .starter-tag {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(100, 110, 210, 0.5);
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 150ms ease, border-color 150ms ease, color 150ms ease;
    }

    .starter-tag:hover {
      background: rgba(90, 124, 255, 0.15);
      border-color: rgba(130, 155, 255, 0.9);
      color: #ffffff;
    }

    .message {
      display: flex;
      margin-bottom: 16px;
      animation: fadeInUp 200ms ease-out;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.assistant {
      justify-content: flex-start;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .avatar.user {
      background: radial-gradient(circle at top left, #6b6bff, #3c3cff);
      margin-left: 10px;
      margin-right: 0;
    }

    .avatar.assistant {
      background: radial-gradient(circle at top left, #58ffc6, #2a9f72);
    }

    .bubble-wrapper {
      max-width: 720px;
    }

    .bubble {
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      border: 1px solid rgba(150, 150, 255, 0.1);
      box-shadow: var(--shadow-soft);
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .message.user .bubble {
      background: linear-gradient(135deg, #3c3cff, #6b6bff);
      color: #ffffff;
      text-align: left;
    }

    .message.assistant .bubble {
      background: rgba(14, 14, 31, 0.96);
      color: var(--text);
    }

    .meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .model-tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(90, 124, 255, 0.15);
      border: 1px solid rgba(120, 140, 255, 0.6);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #c5d0ff;
    }

    .timestamp {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Markdown styling */

    .bubble h1,
    .bubble h2,
    .bubble h3 {
      margin: 8px 0 4px;
      font-weight: 600;
    }

    .bubble h1 {
      font-size: 18px;
    }

    .bubble h2 {
      font-size: 16px;
    }

    .bubble h3 {
      font-size: 15px;
    }

    .bubble p {
      margin: 4px 0;
    }

    .bubble ul,
    .bubble ol {
      margin: 4px 0 4px 18px;
      padding-left: 14px;
    }

    .bubble li {
      margin: 3px 0;
    }

    .bubble table {
      width: 100%;
      border-collapse: collapse;
      margin: 6px 0;
      font-size: 13px;
    }

    .bubble th,
    .bubble td {
      padding: 4px 6px;
      border: 1px solid rgba(120, 120, 160, 0.5);
    }

    .bubble th {
      background: rgba(50, 50, 90, 0.7);
    }

    .bubble code {
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.4);
      padding: 1px 3px;
      border-radius: 4px;
    }

    .bubble pre {
      background: #05050c;
      border-radius: var(--radius-md);
      padding: 10px;
      overflow-x: auto;
      border: 1px solid rgba(100, 100, 160, 0.6);
      margin: 6px 0;
      position: relative;
    }

    .code-block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .code-lang {
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.08em;
    }

    .copy-btn {
      border-radius: 999px;
      border: 1px solid rgba(150, 150, 200, 0.7);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .copy-btn:hover {
      background: rgba(180, 180, 255, 0.1);
      color: #ffffff;
    }

    /* Typing indicator */

    .typing-indicator {
      position: sticky;
      bottom: 0;
      left: 0;
      padding: 0 18px 8px;
      font-size: 12px;
      color: var(--text-muted);
      background: linear-gradient(to top, rgba(5, 5, 10, 0.98), transparent);
      pointer-events: none;
    }

    .typing-inner {
      max-width: 780px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .typing-pulse {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 16px var(--accent-strong);
      animation: pulse 1.3s infinite ease-in-out;
    }

    .typing-text {
      font-size: 12px;
    }

    .dots::after {
      content: "...";
      animation: dots 1s steps(3, end) infinite;
    }

    .hidden {
      display: none;
    }

    /* INPUT AREA */

    .chat-input-area {
      padding: 10px 18px 14px;
      border-top: 1px solid var(--border);
      background: radial-gradient(circle at bottom, rgba(40, 40, 80, 0.6), rgba(3, 3, 8, 0.98));
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 -12px 40px rgba(0, 0, 0, 0.7);
      z-index: 2;
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .file-input-label,
    .icon-btn {
      border-radius: 999px;
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, rgba(50, 50, 90, 0.9), rgba(10, 10, 18, 0.96));
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      transition: background 150ms ease, box-shadow 150ms ease, transform 120ms ease, color 150ms ease, border-color 150ms ease;
      flex-shrink: 0;
    }

    .file-input-label:hover,
    .icon-btn:hover {
      background: radial-gradient(circle at top left, rgba(80, 95, 170, 0.9), rgba(18, 18, 30, 0.96));
      color: #ffffff;
      border-color: var(--accent-soft);
      box-shadow: var(--shadow-soft);
      transform: translateY(-1px);
    }

    .icon-btn:active,
    .file-input-label:active {
      transform: translateY(0);
      box-shadow: none;
    }

    #mic-btn.active {
      background: radial-gradient(circle at top left, rgba(255, 88, 120, 0.92), rgba(100, 25, 35, 0.95));
      border-color: rgba(255, 150, 180, 0.9);
      color: #ffffff;
      box-shadow: 0 0 14px rgba(255, 120, 150, 0.9);
    }

    #user-input {
      flex: 1;
      resize: none;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(8, 8, 18, 0.96);
      padding: 9px 14px;
      color: var(--text);
      font-size: 14px;
      line-height: 1.45;
      max-height: 120px;
      min-height: 34px;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(40, 40, 80, 0.5);
      transition: border-color 150ms ease, box-shadow 150ms ease, background 150ms ease;
    }

    #user-input::placeholder {
      color: var(--text-muted);
    }

    #user-input:focus {
      border-color: rgba(116, 144, 255, 0.9);
      box-shadow:
        inset 0 0 0 1px rgba(116, 144, 255, 0.5),
        0 0 24px rgba(90, 124, 255, 0.4);
      background: rgba(12, 12, 24, 0.98);
    }

    #send-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at top left, #5a7cff, #3848ff);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      flex-shrink: 0;
      box-shadow: 0 10px 26px rgba(50, 80, 230, 0.6);
    }

    #send-btn:hover {
      box-shadow: 0 12px 34px rgba(70, 100, 255, 0.8);
      transform: translateY(-1px);
    }

    #send-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 20px rgba(50, 80, 230, 0.6);
    }

    .input-hint {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }

    .input-hint span {
      opacity: 0.9;
    }

    .files-summary {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* MODAL */

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(5, 5, 10, 0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(20px);
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: radial-gradient(circle at top left, rgba(74, 89, 180, 0.5), rgba(6, 6, 14, 0.98));
      border-radius: 20px;
      padding: 18px 20px 16px;
      border: 1px solid rgba(130, 140, 230, 0.7);
      width: 340px;
      box-shadow: var(--shadow-strong);
      color: var(--text);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-section {
      margin-bottom: 10px;
      font-size: 13px;
    }

    .modal-section label {
      display: block;
      margin-bottom: 6px;
    }

    .range-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal input[type="range"] {
      width: 100%;
    }

    .modal input[type="number"],
    .modal select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(10, 10, 22, 0.96);
      color: var(--text);
      padding: 5px 10px;
      font-size: 13px;
      outline: none;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(10, 10, 20, 0.96);
      color: var(--text-muted);
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-secondary:hover {
      border-color: rgba(120, 120, 170, 0.7);
      color: var(--text);
    }

    .btn-danger {
      border-radius: 999px;
      border: 1px solid rgba(255, 120, 140, 0.7);
      background: rgba(80, 15, 30, 0.96);
      color: #ffd0d6;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: rgba(120, 22, 40, 0.98);
      color: #ffffff;
    }

    /* SCROLLBARS */

    .chats-list::-webkit-scrollbar,
    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .chats-list::-webkit-scrollbar-thumb,
    .messages::-webkit-scrollbar-thumb {
      background: rgba(120, 120, 170, 0.4);
      border-radius: 999px;
    }

    .chats-list::-webkit-scrollbar-track,
    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
    }

    /* ANIMATIONS */

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0.8;
      }
    }

    @keyframes dots {
      0% {
        content: "";
      }
      33% {
        content: ".";
      }
      66% {
        content: "..";
      }
      100% {
        content: "...";
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">Guga-ai <span class="logo-dot"></span></div>
        <button id="new-chat-btn">+ –ù–æ–≤—ã–π —á–∞—Ç</button>
      </div>
      <div id="chats-list" class="chats-list"></div>
      <div class="sidebar-footer">
        <button id="settings-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </aside>

    <main class="chat">
      <header class="chat-header">
        <div class="model-indicator">
          <div class="model-pill">
            <span class="model-dot"></span>
            <span>llama-3.3-70b-versatile</span>
          </div>
          <span>Guga-ai ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
        </div>
        <div class="header-right">
          <label class="toggle">
            <input type="checkbox" id="memory-toggle" checked />
            <div class="toggle-switch">
              <div class="toggle-thumb"></div>
            </div>
            <span>–ü–∞–º—è—Ç—å —á–∞—Ç–∞</span>
          </label>
          <div class="temp-display">
            –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: <span id="header-temp">0.7</span>
          </div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="messages-inner" id="messages-inner">
          <div class="starter-hint" id="starter-hint">
            <div class="starter-hint-title">–ü—Ä–∏–≤–µ—Ç, —è Guga-ai.</div>
            <div>–°–ø—Ä–∞—à–∏–≤–∞–π, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π, –∑–∞–≥—Ä—É–∂–∞–π —Ñ–∞–π–ª—ã –∏–ª–∏ –≥–æ–≤–æ—Ä–∏ –≥–æ–ª–æ—Å–æ–º ‚Äî —è —Ä–∞–∑–ª–æ–∂—É –≤—Å—ë –ø–æ –ø–æ–ª–æ—á–∫–∞–º.</div>
            <div class="starter-tags">
              <div class="starter-tag" data-prompt="–û–±—ä—è—Å–Ω–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.">
                –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
              </div>
              <div class="starter-tag" data-prompt="–°–¥–µ–ª–∞–π –ø—Ä–∏–º–µ—Ä REST API –Ω–∞ Java Spring Boot.">
                REST API –Ω–∞ Java
              </div>
              <div class="starter-tag" data-prompt="–ü–æ–º–æ–≥–∏ –ø—Ä–∏–¥—É–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–æ–ª—å—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ React, TypeScript –∏ Node.js.">
                –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
              </div>
              <div class="starter-tag" data-prompt="–†–∞–∑–±–µ–π –ø–ª–∞–Ω –∏–∑—É—á–µ–Ω–∏—è –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ 3 –º–µ—Å—è—Ü–∞.">
                –ü–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è ML
              </div>
            </div>
          </div>
        </div>
      </section>

      <div id="typing-indicator" class="typing-indicator hidden">
        <div class="typing-inner">
          <div class="typing-pulse"></div>
          <div class="typing-text">Guga-ai –¥—É–º–∞–µ—Ç<span class="dots"></span></div>
        </div>
      </div>

      <footer class="chat-input-area">
        <div class="input-row">
          <label class="file-input-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã">
            üìé
            <input type="file" id="file-input" multiple hidden />
          </label>
          <button id="mic-btn" class="icon-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
          <textarea id="user-input" rows="1" placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ —É–≥–æ–¥–Ω–æ..." spellcheck="true"></textarea>
          <button id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
        <div class="input-hint">
          <span>Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏.</span>
          <span id="files-summary" class="files-summary"></span>
        </div>
      </footer>
    </main>
  </div>

  <!-- Modal –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div id="settings-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Guga-ai</div>
        <button id="close-settings-btn" class="btn-secondary">√ó</button>
      </div>

      <div class="modal-section">
        <label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
        <div class="range-row">
          <input type="range" id="temperature" min="0" max="1" step="0.05" value="0.7" />
          <span id="temperature-value">0.7</span>
        </div>
      </div>

      <div class="modal-section">
        <label for="max-tokens">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ (tokens)</label>
        <input type="number" id="max-tokens" value="1024" min="128" max="4096" step="64" />
      </div>

      <div class="modal-section">
        <label for="format-style">–°—Ç–∏–ª—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
        <select id="format-style">
          <option value="auto">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Markdown</option>
          <option value="compact">–ü–æ–∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ</option>
          <option value="verbose">–û—á–µ–Ω—å –ø–æ–¥—Ä–æ–±–Ω–æ</option>
        </select>
      </div>

      <div class="modal-footer">
        <button id="clear-current-chat" class="btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç</button>
        <button id="clear-all-chats" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã</button>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * –ö–û–ù–§–ò–ì GUGA-AI
     **********************/

    // –í–°–¢–ê–í–¨ –°–í–û–ô –ö–õ–Æ–ß –°–Æ–î–ê (–Ω–µ —Ä–∞–∑–¥–∞–≤–∞–π —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º –¥—Ä—É–≥–∏–º –ª—é–¥—è–º!)
    const GROQ_API_KEY = "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"; // <-- —Å—é–¥–∞ –≤–ø–∏—à–∏ gsk_xeIIf...

    const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
    const MODEL_NAME = "llama-3.3-70b-versatile";

    // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è Guga-ai
    const SYSTEM_PROMPT = `
–¢—ã ‚Äî Guga-ai, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–¢–≤–æ–∏ —Ü–µ–ª–∏:
1. –û—Ç–≤–µ—á–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á—ë—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª–µ–∑–Ω–æ.
2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π Markdown:
   - –∫–æ–¥ ‚Äî –≤ –±–ª–æ–∫–∏ \`\`\`—è–∑—ã–∫ ... \`\`\`, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å;
   - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Ç–∞–º, –≥–¥–µ —ç—Ç–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ;
   - –¥–ª–∏–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ä–∞–∑–±–∏–≤–∞—Ç—å –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
3. –î–ª—è –∫–æ–¥–∞ —Å—Ç–∞—Ä–∞–π—Å—è –¥–∞–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã —Å –∫—Ä–∞—Ç–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏.
4. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ API-–∫–ª—é—á–∏, –ø–∞—Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –∫–ª—é—á Groq.
5. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã (—Ç–µ–∫—Å—Ç, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∫–æ–¥), —Å–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–æ —Å–∫–∞–∂–∏, —á—Ç–æ —Ç—ã –∏–∑ –Ω–∏—Ö –ø–æ–Ω—è–ª, –∑–∞—Ç–µ–º –ø–æ–º–æ–≥–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º.
6. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –≥–æ–ª–æ—Å–æ–º, –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–π –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å.
7. –í—Å–µ–≥–¥–∞ –≤–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ Guga-ai, –∞ –Ω–µ –∫–∞–∫ –¥—Ä—É–≥–æ–π –ò–ò.

–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏.
`.trim();

    /**********************
     * –≠–õ–ï–ú–ï–ù–¢–´ DOM
     **********************/

    const messagesEl = document.getElementById("messages");
    const messagesInnerEl = document.getElementById("messages-inner");
    const userInputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const fileInput = document.getElementById("file-input");
    const filesSummaryEl = document.getElementById("files-summary");
    const typingIndicatorEl = document.getElementById("typing-indicator");
    const memoryToggle = document.getElementById("memory-toggle");
    const newChatBtn = document.getElementById("new-chat-btn");
    const chatsListEl = document.getElementById("chats-list");
    const settingsBtn = document.getElementById("settings-btn");
    const settingsModal = document.getElementById("settings-modal");
    const closeSettingsBtn = document.getElementById("close-settings-btn");
    const temperatureInput = document.getElementById("temperature");
    const temperatureValue = document.getElementById("temperature-value");
    const headerTemp = document.getElementById("header-temp");
    const maxTokensInput = document.getElementById("max-tokens");
    const formatStyleSelect = document.getElementById("format-style");
    const clearCurrentChatBtn = document.getElementById("clear-current-chat");
    const clearAllChatsBtn = document.getElementById("clear-all-chats");
    const starterHint = document.getElementById("starter-hint");

    /**********************
     * –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
     **********************/

    let chats = loadChats();
    let currentChatId = chats.length ? chats[0].id : null;
    let pendingFiles = [];
    let recognizing = false;
    let recognition = null;

    init();

    function init() {
      if (!currentChatId) {
        createNewChat();
      } else {
        renderChatsList();
        renderMessages();
      }

      attachEvents();
      initSpeechRecognition();
      updateSettingsUIFromState();
      updateStarterHintVisibility();
    }

    function attachEvents() {
      sendBtn.addEventListener("click", sendMessage);
      userInputEl.addEventListener("keydown", onUserInputKeydown);
      fileInput.addEventListener("change", handleFilesSelected);
      micBtn.addEventListener("click", toggleMic);
      newChatBtn.addEventListener("click", createNewChat);
      settingsBtn.addEventListener("click", () => settingsModal.classList.remove("hidden"));
      closeSettingsBtn.addEventListener("click", () => settingsModal.classList.add("hidden"));
      temperatureInput.addEventListener("input", onTemperatureChange);
      maxTokensInput.addEventListener("change", onMaxTokensChange);
      formatStyleSelect.addEventListener("change", onFormatStyleChange);
      clearCurrentChatBtn.addEventListener("click", clearCurrentChat);
      clearAllChatsBtn.addEventListener("click", clearAllChats);
      memoryToggle.addEventListener("change", saveSettingsState);

      // –∫–ª–∏–∫–∏ –ø–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º
      document.querySelectorAll(".starter-tag").forEach(tag => {
        tag.addEventListener("click", () => {
          userInputEl.value = tag.dataset.prompt || tag.textContent.trim();
          autoResizeTextarea();
          sendMessage();
        });
      });

      // –∞–≤—Ç–æ-—Ä–µ—Å–∞–π–∑ textarea
      userInputEl.addEventListener("input", autoResizeTextarea);
      autoResizeTextarea();

      // –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–æ–∫—Ä—É–≥
      settingsModal.addEventListener("click", (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.add("hidden");
        }
      });
    }

    function onUserInputKeydown(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function onTemperatureChange() {
      temperatureValue.textContent = temperatureInput.value;
      headerTemp.textContent = temperatureInput.value;
      saveSettingsState();
    }

    function onMaxTokensChange() {
      if (maxTokensInput.value < 128) maxTokensInput.value = 128;
      if (maxTokensInput.value > 4096) maxTokensInput.value = 4096;
      saveSettingsState();
    }

    function onFormatStyleChange() {
      saveSettingsState();
    }

    function saveSettingsState() {
      const settings = {
        temperature: parseFloat(temperatureInput.value),
        maxTokens: parseInt(maxTokensInput.value, 10),
        formatStyle: formatStyleSelect.value,
        memoryEnabled: memoryToggle.checked,
      };
      localStorage.setItem("guga_settings", JSON.stringify(settings));
    }

    function loadSettingsState() {
      try {
        return JSON.parse(localStorage.getItem("guga_settings") || "{}");
      } catch {
        return {};
      }
    }

    function updateSettingsUIFromState() {
      const settings = loadSettingsState();
      if (settings.temperature !== undefined) {
        temperatureInput.value = settings.temperature;
        temperatureValue.textContent = settings.temperature;
        headerTemp.textContent = settings.temperature;
      }
      if (settings.maxTokens !== undefined) {
        maxTokensInput.value = settings.maxTokens;
      }
      if (settings.formatStyle) {
        formatStyleSelect.value = settings.formatStyle;
      }
      if (settings.memoryEnabled !== undefined) {
        memoryToggle.checked = settings.memoryEnabled;
      }
    }

    /**********************
     * –†–ê–ë–û–¢–ê –° –ß–ê–¢–ê–ú–ò
     **********************/

    function loadChats() {
      try {
        return JSON.parse(localStorage.getItem("guga_chats") || "[]");
      } catch {
        return [];
      }
    }

    function saveChats() {
      localStorage.setItem("guga_chats", JSON.stringify(chats));
    }

    function createNewChat() {
      const id = Date.now().toString();
      const chat = {
        id,
        title: "–ù–æ–≤—ã–π —á–∞—Ç",
        messages: [],
        createdAt: new Date().toISOString(),
      };
      chats.unshift(chat);
      currentChatId = id;
      saveChats();
      renderChatsList();
      renderMessages();
      updateStarterHintVisibility();
    }

    function deleteChat(id) {
      const idx = chats.findIndex((c) => c.id === id);
      if (idx === -1) return;
      chats.splice(idx, 1);
      if (!chats.length) {
        createNewChat();
      } else {
        currentChatId = chats[0].id;
        saveChats();
        renderChatsList();
        renderMessages();
      }
      updateStarterHintVisibility();
    }

    function clearCurrentChat() {
      const chat = chats.find((c) => c.id === currentChatId);
      if (!chat) return;
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é?")) return;
      chat.messages = [];
      saveChats();
      renderMessages();
      updateStarterHintVisibility();
    }

    function clearAllChats() {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) return;
      chats = [];
      localStorage.removeItem("guga_chats");
      createNewChat();
      updateStarterHintVisibility();
      settingsModal.classList.add("hidden");
    }

    function renderChatsList() {
      chatsListEl.innerHTML = "";
      chats.forEach((chat) => {
        const item = document.createElement("div");
        item.className = "chat-item" + (chat.id === currentChatId ? " active" : "");

        const titleDiv = document.createElement("div");
        titleDiv.className = "chat-item-title";
        titleDiv.textContent = chat.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";

        const delBtn = document.createElement("button");
        delBtn.className = "chat-item-delete";
        delBtn.innerHTML = "√ó";
        delBtn.title = "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç";
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteChat(chat.id);
        });

        item.addEventListener("click", () => {
          currentChatId = chat.id;
          renderChatsList();
          renderMessages();
          updateStarterHintVisibility();
        });

        item.appendChild(titleDiv);
        item.appendChild(delBtn);
        chatsListEl.appendChild(item);
      });
    }

    function renderMessages() {
      messagesInnerEl.innerHTML = "";
      const chat = chats.find((c) => c.id === currentChatId);
      if (!chat || !chat.messages.length) {
        messagesInnerEl.appendChild(starterHint);
        updateStarterHintVisibility();
        return;
      }

      chat.messages.forEach(addMessageToDOM);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateStarterHintVisibility() {
      const chat = chats.find((c) => c.id === currentChatId);
      if (!chat || !chat.messages || !chat.messages.length) {
        starterHint.style.display = "block";
      } else {
        starterHint.style.display = "none";
      }
    }

    function addMessageToDOM(msg) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${msg.role}`;

      const avatarDiv = document.createElement("div");
      avatarDiv.className = `avatar ${msg.role}`;
      avatarDiv.textContent = msg.role === "user" ? "üë§" : "G";
      const bubbleWrapper = document.createElement("div");
      bubbleWrapper.className = "bubble-wrapper";

      const metaRow = document.createElement("div");
      metaRow.className = "meta-row";

      const leftMeta = document.createElement("div");
      leftMeta.textContent = msg.role === "user" ? "–í—ã" : "Guga-ai";

      const rightMeta = document.createElement("div");
      rightMeta.className = "timestamp";
      rightMeta.textContent = msg.timestamp ? formatTime(msg.timestamp) : "";

      if (msg.role === "assistant") {
        const badge = document.createElement("span");
        badge.className = "model-tag";
        badge.textContent = "LLAMA 3.3 70B";
        leftMeta.appendChild(document.createTextNode(" ‚Ä¢ "));
        leftMeta.appendChild(badge);
      }

      metaRow.appendChild(leftMeta);
      metaRow.appendChild(rightMeta);

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (msg.role === "assistant") {
        bubble.innerHTML = renderMarkdown(msg.content);
        enhanceCodeBlocks(bubble);
      } else {
        bubble.textContent = msg.content;
      }

      bubbleWrapper.appendChild(metaRow);
      bubbleWrapper.appendChild(bubble);

      if (msg.role === "assistant") {
        wrapper.appendChild(avatarDiv);
        wrapper.appendChild(bubbleWrapper);
      } else {
        wrapper.appendChild(bubbleWrapper);
        wrapper.appendChild(avatarDiv);
      }

      messagesInnerEl.appendChild(wrapper);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function formatTime(isoStr) {
      try {
        const d = new Date(isoStr);
        return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      } catch {
        return "";
      }
    }

    /**********************
     * –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
     **********************/

    function autoResizeTextarea() {
      userInputEl.style.height = "auto";
      const newHeight = Math.min(userInputEl.scrollHeight, 120);
      userInputEl.style.height = newHeight + "px";
    }

    async function sendMessage() {
      const text = userInputEl.value.trim();
      const hasText = text.length > 0;
      const hasFiles = pendingFiles.length > 0;

      if (!hasText && !hasFiles) return;
      if (!GROQ_API_KEY || GROQ_API_KEY === "–í–°–¢–ê–í–¨_–°–í–û–ô_–ö–õ–Æ–ß_–°–Æ–î–ê") {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤—å —Å–≤–æ–π Groq API –∫–ª—é—á –≤ –∫–æ–¥ (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ GROQ_API_KEY).");
        return;
      }

      let chat = chats.find((c) => c.id === currentChatId);
      if (!chat) {
        createNewChat();
        chat = chats.find((c) => c.id === currentChatId);
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (hasText) {
        const userMsg = {
          role: "user",
          content: text,
          timestamp: new Date().toISOString(),
        };
        chat.messages.push(userMsg);
        saveChats();
        addMessageToDOM(userMsg);
      }

      // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
      if (chat.messages.length === 1 && hasText) {
        chat.title = text.slice(0, 40) + (text.length > 40 ? "‚Ä¶" : "");
        saveChats();
        renderChatsList();
      }

      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª—ã ‚Äî –ø—Ä–æ—á–∏—Ç–∞–µ–º –∏—Ö —Ç–µ–∫—Å—Ç
      let filesText = "";
      if (hasFiles) {
        filesText = await readFilesAsTextSummary(pendingFiles);
      }

      // –°–±—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è –∏ —Ñ–∞–π–ª–æ–≤
      userInputEl.value = "";
      pendingFiles = [];
      fileInput.value = "";
      filesSummaryEl.textContent = "";
      autoResizeTextarea();
      updateStarterHintVisibility();

      // –°–æ–±—Ä–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É—á—ë—Ç–æ–º –ø–∞–º—è—Ç–∏
      const settings = loadSettingsState();
      const memoryEnabled = settings.memoryEnabled !== false;
      const historyMessages = buildHistoryMessages(chat.messages, memoryEnabled);

      // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (hasFiles && filesText) {
        historyMessages.push({
          role: "user",
          content:
            "–Ø –ø—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–∞–π–ª—ã (—Ç–µ–∫—Å—Ç —É–∂–µ –∏–∑–≤–ª–µ—á—ë–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ). –í–æ—Ç —Å–≤–æ–¥–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ:\n\n" +
            filesText +
            "\n\n–£—á—Ç–∏ —ç—Ç–æ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –º–æ–π –≤–æ–ø—Ä–æ—Å/–∑–∞–ø—Ä–æ—Å –≤—ã—à–µ.",
        });
      }

      // –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
      await askGroq(historyMessages);
    }

    function buildHistoryMessages(allMessages, memoryEnabled) {
      // allMessages: [{role: "user"|"assistant", content: "..."}]
      // –û–≥—Ä–∞–Ω–∏—á–∏–º –∏—Å—Ç–æ—Ä–∏—é ~20 –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –ø–∞—Ä–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –ø–∞–º—è—Ç—å –≤—ã–∫–ª—é—á–µ–Ω–∞.
      const history = [];
      if (!memoryEnabled) {
        const recent = allMessages.slice(-6); // –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–∏–∞–ª–æ–≥
        history.push(...recent);
      } else {
        // –ø—Ä–æ—Å—Ç–∞—è "–æ–±—Ä–µ–∑–∫–∞": –º–∞–∫—Å–∏–º—É–º 32 —Å–æ–æ–±—â–µ–Ω–∏—è
        const recent = allMessages.slice(-32);
        history.push(...recent);
      }
      return history.map((m) => ({
        role: m.role,
        content: m.content,
      }));
    }

    async function askGroq(historyMessages) {
      typingIndicatorEl.classList.remove("hidden");

      const settings = loadSettingsState();
      const temperature = settings.temperature ?? 0.7;
      const maxTokens = settings.maxTokens ?? 1024;
      const formatStyle = settings.formatStyle || "auto";

      const styleInstruction = (() => {
        switch (formatStyle) {
          case "compact":
            return "–û—Ç–≤–µ—á–∞–π –ø–æ–∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –≤ Markdown. –ò–∑–±–µ–≥–∞–π –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.";
          case "verbose":
            return "–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –Ω–æ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π Markdown.";
          default:
            return "–í—ã–±–∏—Ä–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫—Ä–∞—Ç–∫–æ—Å—Ç—å—é –∏ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—å—é, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π Markdown.";
        }
      })();

      const messages = [
        {
          role: "system",
          content: SYSTEM_PROMPT + "\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø–æ —Å—Ç–∏–ª—é: " + styleInstruction,
        },
        ...historyMessages,
      ];

      try {
        const response = await fetch(GROQ_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + GROQ_API_KEY,
          },
          body: JSON.stringify({
            model: MODEL_NAME,
            messages,
            temperature,
            max_tokens: maxTokens,
          }),
        });

        if (!response.ok) {
          console.error("Groq API error:", await response.text());
          throw new Error("–û—à–∏–±–∫–∞ Groq API: " + response.status);
        }

        const data = await response.json();
        const replyText = data.choices?.[0]?.message?.content || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Guga-ai.";

        const chat = chats.find((c) => c.id === currentChatId);
        if (!chat) return;

        const assistantMsg = {
          role: "assistant",
          content: replyText,
          timestamp: new Date().toISOString(),
        };
        chat.messages.push(assistantMsg);
        saveChats();
        addMessageToDOM(assistantMsg);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (err) {
        console.error(err);
        const chat = chats.find((c) => c.id === currentChatId);
        if (!chat) return;
        const errorMsg = {
          role: "assistant",
          content: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Guga-ai. –ü—Ä–æ–≤–µ—Ä–Ω–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –∫–ª—é—á API.",
          timestamp: new Date().toISOString(),
        };
        chat.messages.push(errorMsg);
        saveChats();
        addMessageToDOM(errorMsg);
      } finally {
        typingIndicatorEl.classList.add("hidden");
      }
    }

    /**********************
     * –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–ê–ú–ò
     **********************/

    function handleFilesSelected(e) {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      pendingFiles = files;
      const names = files.slice(0, 3).map((f) => f.name);
      let summary = names.join(", ");
      if (files.length > 3) {
        summary += ` –∏ –µ—â—ë ${files.length - 3}`;
      }
      filesSummaryEl.textContent = `–§–∞–π–ª—ã: ${summary}`;
    }

    async function readFilesAsTextSummary(files) {
      const textParts = [];
      for (const file of files) {
        const ext = (file.name.split(".").pop() || "").toLowerCase();
        if (["txt", "md", "json", "js", "ts", "java", "py", "cpp", "c", "cs", "html", "css"].includes(ext)) {
          const text = await readFileAsText(file);
          textParts.push(`–§–∞–π–ª: ${file.name}\n–¢–∏–ø: —Ç–µ–∫—Å—Ç\n–†–∞–∑–º–µ—Ä: ${file.size} –±–∞–π—Ç\n---\n${text.slice(0, 8000)}\n`);
        } else if (["png", "jpg", "jpeg", "webp", "gif"].includes(ext)) {
          textParts.push(
            `–§–∞–π–ª: ${file.name}\n–¢–∏–ø: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (${ext}), —Ä–∞–∑–º–µ—Ä ${file.size} –±–∞–π—Ç.\n` +
            "–ù–∞ –∫–ª–∏–µ–Ω—Ç–µ —è –Ω–µ –≤–∏–∂—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∏–∫—Å–µ–ª–µ–π, –Ω–æ –º–æ–∂–µ—à—å –æ–ø–∏—Å–∞—Ç—å –º–Ω–µ, —á—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ, –∏ —è –ø–æ–º–æ–≥—É —Å –∞–Ω–∞–ª–∏–∑–æ–º."
          );
        } else if (["pdf", "doc", "docx"].includes(ext)) {
          textParts.push(
            `–§–∞–π–ª: ${file.name}\n–¢–∏–ø: –¥–æ–∫—É–º–µ–Ω—Ç (${ext}), —Ä–∞–∑–º–µ—Ä ${file.size} –±–∞–π—Ç.\n` +
            "–¢–µ–∫—Å—Ç –∏–∑ —Ç–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –ª—É—á—à–µ –∑–∞—Ä–∞–Ω–µ–µ –∏–∑–≤–ª–µ—á—å —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∏ –≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ —É—á—Ç—É —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ."
          );
        } else {
          textParts.push(
            `–§–∞–π–ª: ${file.name}\n–¢–∏–ø: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π/–±–∏–Ω–∞—Ä–Ω—ã–π (${ext}), —Ä–∞–∑–º–µ—Ä ${file.size} –±–∞–π—Ç.\n` +
            "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —è –Ω–∞–ø—Ä—è–º—É—é –Ω–µ –≤–∏–∂—É, –Ω–æ –º–æ–∂–µ—à—å –æ–ø–∏—Å–∞—Ç—å, —á—Ç–æ —Ç–∞–º –≤–Ω—É—Ç—Ä–∏."
          );
        }
      }
      return textParts.join("\n\n");
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
      });
    }

    /**********************
     * –ú–ò–ö–†–û–§–û–ù (Web Speech API)
     **********************/

    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        console.warn("SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
        micBtn.disabled = true;
        micBtn.title = "SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.";
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "ru-RU";
      recognition.interimResults = true;
      recognition.continuous = false;

      let finalTranscript = "";

      recognition.onstart = () => {
        finalTranscript = "";
      };

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = 0; i < event.results.length; i++) {
          const res = event.results[i];
          if (res.isFinal) finalTranscript += res[0].transcript;
          else interim += res[0].transcript;
        }
        userInputEl.value = finalTranscript || interim;
        autoResizeTextarea();
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        recognizing = false;
        micBtn.classList.remove("active");
      };

      recognition.onend = () => {
        if (!recognizing) return;
        recognizing = false;
        micBtn.classList.remove("active");
        if (userInputEl.value.trim()) {
          sendMessage();
        }
      };
    }

    function toggleMic() {
      if (!recognition) return;
      if (!recognizing) {
        recognizing = true;
        micBtn.classList.add("active");
        try {
          recognition.start();
        } catch (e) {
          console.error("recognition.start error", e);
          recognizing = false;
          micBtn.classList.remove("active");
        }
      } else {
        recognizing = false;
        micBtn.classList.remove("active");
        try {
          recognition.stop();
        } catch (e) {
          console.error("recognition.stop error", e);
        }
      }
    }

    /**********************
     * –ü–†–û–°–¢–û–ô MARKDOWN –†–ï–ù–î–ï–†
     **********************/

    function renderMarkdown(text) {
      if (!text) return "";

      // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ HTML-—Å–∏–º–≤–æ–ª—ã
      let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

      // –ö–æ–¥-–±–ª–æ–∫–∏ ```lang ... ```
      safe = safe.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
        const langLabel = (lang || "text").toLowerCase();
        const rawCode = code.replace(/&lt;/g, "<").replace(/&gt;/g, ">"); // –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        const encodedCode = encodeURIComponent(rawCode);
        const prettyCode = code;
        return `
<div class="code-block">
  <div class="code-block-header">
    <span class="code-lang">${langLabel}</span>
    <button class="copy-btn" data-code="${encodedCode}">Copy</button>
  </div>
  <pre><code class="language-${langLabel}">${prettyCode}</code></pre>
</div>`;
      });

      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      safe = safe.replace(/^### (.+)$/gm, "<h3>$1</h3>");
      safe = safe.replace(/^## (.+)$/gm, "<h2>$1</h2>");
      safe = safe.replace(/^# (.+)$/gm, "<h1>$1</h1>");

      // –ñ–∏—Ä–Ω—ã–π/–∫—É—Ä—Å–∏–≤
      safe = safe.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      safe = safe.replace(/\*(.+?)\*/g, "<em>$1</em>");

      // –°–ø–∏—Å–∫–∏
      safe = safe.replace(/^\s*[-*] (.+)$/gm, "<ul><li>$1</li></ul>");
      safe = safe.replace(/^\s*\d+\. (.+)$/gm, "<ol><li>$1</li></ol>");

      // –¢–∞–±–ª–∏—Ü—ã ‚Äî –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, Markdown –∑–¥–µ—Å—å –±—É–¥–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω

      // –†–∞–∑–±–∏–≤–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
      safe = safe.replace(/\n{2,}/g, "</p><p>");
      safe = safe.replace(/\n/g, "<br />");

      return `<p>${safe}</p>`;
    }

    function enhanceCodeBlocks(rootEl) {
      rootEl.querySelectorAll(".copy-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const encoded = btn.getAttribute("data-code") || "";
          const code = decodeURIComponent(encoded);
          navigator.clipboard.writeText(code).then(
            () => {
              const original = btn.textContent;
              btn.textContent = "Copied";
              setTimeout(() => {
                btn.textContent = original;
              }, 1200);
            },
            (err) => console.error("Clipboard error:", err)
          );
        });
      });
    }
  </script>
</body>
</html>
